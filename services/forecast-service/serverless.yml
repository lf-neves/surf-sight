# "org" ensures this Service is used with the correct Serverless Framework License Key.
org: lfnservices
service: forecast-service

provider:
  name: aws
  runtime: nodejs22.x
  # Defaults to 'development' if not provided via CLI option
  stage: ${opt:stage, 'development'}
  # Defaults to 'us-east-1' if AWS_REGION env var not set
  region: ${env:AWS_REGION, 'us-east-1'}
  environment:
    DATABASE_URL: ${env:DATABASE_URL, ''}
    SQS_QUEUE_URL: ${env:SQS_QUEUE_URL, 'http://localhost:9324/queue/forecast-queue'}
    API_ENV: ${env:API_ENV, 'development'}
  iam:
    role:
      statements:
        # Allow forecast worker to enqueue insight jobs (second queue)
        - Effect: Allow
          Action: sqs:SendMessage
          Resource: !GetAtt InsightJobQueue.Arn

useDotenv: true

build:
  esbuild:
    bundle: true
    sourcemap: true
    target: node22
    platform: node
    format: cjs
    external:
      - '@aws-sdk/*'
    minify: false

package:
  individually: true
  excludeDevDependencies: true
  patterns:
    - 'node_modules/.pnpm/**/@prisma+client@*/**'
    - '!node_modules/.pnpm/**/@prisma+client@*/**/libquery_engine-*'
    - 'node_modules/.pnpm/**/@prisma+client@*/**/libquery_engine-rhel-openssl-3.0.x.so.node'
    - '!node_modules/.prisma/client/libquery_engine-*'
    - 'node_modules/.prisma/client/libquery_engine-rhel-openssl-3.0.x.so.node'
    - '!node_modules/prisma/libquery_engine-*'
    - '!node_modules/@prisma/engines/**'
    - '!node_modules/.cache/prisma/**'
    - '!node_modules/**/*.test.*'
    - '!node_modules/**/*.spec.*'

functions:
  enqueueForecasts:
    handler: src/handlers/handleEnqueueRetrievedForecastsToProcess.handleEnqueueRetrievedForecastsToProcess
    # For local testing, you can invoke this manually
    # For production, uncomment one of these event types:
    # events:
    #   - schedule:
    #       rate: rate(1 hour)
    #       enabled: true
    # Or HTTP endpoint for manual triggering:
    #   - http:
    #       path: /forecasts/enqueue
    #       method: post

  processSqsMessage:
    handler: src/handlers/handleSqsMessage.handleSqsMessage
    timeout: 300
    environment:
      SQS_INSIGHT_QUEUE_URL: !Ref InsightJobQueue
    # Note: Dead letter queue is configured via SQS queue RedrivePolicy in resources
    events:
      - sqs:
          arn:
            Fn::GetAtt:
              - ForecastServiceQueue
              - Arn
          batchSize: ${env:SQS_BATCH_SIZE, 10}

resources:
  Resources:
    InsightJobQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:service}-${self:provider.stage}-insight-jobs
        MessageRetentionPeriod: 345600  # 4 days
        VisibilityTimeout: 120  # 2 minutes
        RedrivePolicy:
          deadLetterTargetArn:
            Fn::GetAtt:
              - InsightJobDLQ
              - Arn
          maxReceiveCount: 3

    InsightJobDLQ:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:service}-${self:provider.stage}-insight-jobs-dlq
        MessageRetentionPeriod: 1209600  # 14 days

    ForecastServiceQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:service}-${self:provider.stage}-queue
        MessageRetentionPeriod: 345600  # 4 days
        VisibilityTimeout: 300  # 5 minutes (should match Lambda timeout)
        RedrivePolicy:
          deadLetterTargetArn:
            Fn::GetAtt:
              - ForecastServiceDLQ
              - Arn
          maxReceiveCount: 3

    ForecastServiceDLQ:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:service}-${self:provider.stage}-dlq
        MessageRetentionPeriod: 1209600 # 14 days
        ReceiveMessageWaitTimeSeconds: 0

  Outputs:
    InsightJobQueueArn:
      Description: ARN of the insight jobs queue (consumed by api-service agents)
      Value:
        Fn::GetAtt:
          - InsightJobQueue
          - Arn
      Export:
        Name: ${self:service}-${self:provider.stage}-insight-queue-arn
    InsightJobQueueUrl:
      Description: URL of the insight jobs queue
      Value: !Ref InsightJobQueue
      Export:
        Name: ${self:service}-${self:provider.stage}-insight-queue-url
    ForecastServiceQueueArn:
      Description: ARN of the main SQS Queue
      Value:
        Fn::GetAtt:
          - ForecastServiceQueue
          - Arn
      Export:
        Name: ${self:service}-${self:provider.stage}-queue-arn
    ForecastServiceQueueUrl:
      Description: URL of the main SQS Queue
      Value:
        Ref: ForecastServiceQueue
      Export:
        Name: ${self:service}-${self:provider.stage}-queue-url
    ForecastServiceDLQArn:
      Description: ARN of the Dead Letter Queue
      Value:
        Fn::GetAtt:
          - ForecastServiceDLQ
          - Arn
      Export:
        Name: ${self:service}-${self:provider.stage}-dlq-arn
    ForecastServiceDLQUrl:
      Description: URL of the Dead Letter Queue
      Value:
        Ref: ForecastServiceDLQ
      Export:
        Name: ${self:service}-${self:provider.stage}-dlq-url
