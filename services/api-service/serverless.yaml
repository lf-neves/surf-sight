service: api-service

plugins:
  - serverless-offline

provider:
  name: aws
  runtime: nodejs22.x
  region: us-east-2
  profile: surf-sight
  environment:
    NODE_ENV: production
    DATABASE_URL: ${env:DATABASE_URL, ''}
    JWT_SECRET: ${env:JWT_SECRET, ''}
    OPENAI_API_KEY: ${env:OPENAI_API_KEY, ''}
    TYPESENSE_HOST: ${env:TYPESENSE_HOST, 'localhost'}
    TYPESENSE_PORT: ${env:TYPESENSE_PORT, '8108'}
    TYPESENSE_PROTOCOL: ${env:TYPESENSE_PROTOCOL, 'http'}
    TYPESENSE_API_KEY: ${env:TYPESENSE_API_KEY, 'xyz'}
  vpc:
    securityGroupIds:
      - sg-0c60124c86ca3bc22
    subnetIds:
      - subnet-0b9b119c82a00e47c
      - subnet-0b6424d37c53badef

useDotenv: true

build:
  esbuild:
    bundle: true
    sourcemap: true
    target: node22
    platform: node
    format: cjs
    external:
      - '@aws-sdk/*'
      - '@graphql-tools/*'
      - '@apollo/server'
      - '@as-integrations/aws-lambda'
      - 'graphql'
    loader:
      '.graphql': 'text'

package:
  individually: true
  excludeDevDependencies: true
  patterns:
    - 'node_modules/.pnpm/**/@prisma+client@*/**'
    - '!node_modules/.pnpm/**/@prisma+client@*/**/libquery_engine-*'
    - 'node_modules/.pnpm/**/@prisma+client@*/**/libquery_engine-rhel-openssl-3.0.x.so.node'
    - '!node_modules/.prisma/client/libquery_engine-*'
    - 'node_modules/.prisma/client/libquery_engine-rhel-openssl-3.0.x.so.node'
    - '!node_modules/prisma/libquery_engine-*'
    - '!node_modules/@prisma/engines/**'
    - '!node_modules/.cache/prisma/**'
    - 'src/graphql/modules/**/*.graphql'
    - '!node_modules/**/*.test.*'
    - '!node_modules/**/*.spec.*'
    - '!node_modules/**/test/**'
    - '!node_modules/**/tests/**'
    - '!node_modules/**/__tests__/**'
    - '!node_modules/**/docs/**'
    - '!node_modules/**/examples/**'
    - '!node_modules/**/.git/**'
    - '!node_modules/**/.cache/**'
    - '!node_modules/**/.bin/**'
    - '!node_modules/**/*.md'

functions:
  graphql:
    handler: src/handler.handler
    events:
      - httpApi:
          path: /graphql
          method: ANY
