service: api-service

plugins:
  - serverless-offline
  # Prisma plugin removed - Drizzle doesn't need code generation or special packaging

provider:
  name: aws
  runtime: nodejs22.x
  region: us-east-2
  profile: surf-sight
  deploymentBucket:
    name: ${ssm:/serverless-framework/deployment/s3-bucket}
  iam:
    role:
      statements:
        # Allow Lambda to read from Parameter Store (for runtime access if needed)
        - Effect: Allow
          Action:
            - ssm:GetParameter
            - ssm:GetParameters
            - ssm:GetParametersByPath
          Resource:
            - arn:aws:ssm:us-east-2:*:parameter/surf-sight/*
  environment:
    NODE_ENV: production
    # Prefer .env DATABASE_URL for local dev (serverless offline); otherwise use SSM (deploy)
    DATABASE_URL: ${env:DATABASE_URL, ssm:/surf-sight/db/url}
    JWT_SECRET: ${env:JWT_SECRET, ssm:/surf-sight/api/jwt-secret}
    OPENAI_API_KEY: ${ssm:/surf-sight/api/openai-api-key}
    STORMGLASS_API_KEY: ${env:STORMGLASS_API_KEY, ssm:/surf-sight/api/stormglass-api-key, ''}
    TYPESENSE_HOST: ${ssm:/surf-sight/api/typesense-host, 'localhost'}
    TYPESENSE_PORT: ${ssm:/surf-sight/api/typesense-port, '8108'}
    TYPESENSE_PROTOCOL: ${ssm:/surf-sight/api/typesense-protocol, 'http'}
    TYPESENSE_API_KEY: ${ssm:/surf-sight/api/typesense-api-key, 'xyz'}
  vpc:
    securityGroupIds:
      - sg-0c60124c86ca3bc22
    subnetIds:
      - subnet-0b9b119c82a00e47c
      - subnet-0b6424d37c53badef

useDotenv: true

build:
  esbuild:
    bundle: true
    sourcemap: true
    target: node22
    platform: node
    format: cjs
    external:
      - '@aws-sdk/*'
      - '@graphql-tools/*'
      - '@apollo/server'
      - '@as-integrations/aws-lambda'
      - 'graphql'
      - 'drizzle-orm'
      - 'pg'
      - 'pg-native'
    loader:
      '.graphql': 'text'

package:
  individually: true
  excludeDevDependencies: true
  patterns:
    # Drizzle ORM - no special packaging needed, just include node_modules
    # Include GraphQL files
    - 'src/graphql/modules/**/*.graphql'
    # Exclude test files and unnecessary files
    - '!node_modules/**/*.test.*'
    - '!node_modules/**/*.spec.*'
    - '!node_modules/**/test/**'
    - '!node_modules/**/tests/**'
    - '!node_modules/**/__tests__/**'
    - '!node_modules/**/docs/**'
    - '!node_modules/**/examples/**'
    - '!node_modules/**/.git/**'
    - '!node_modules/**/.bin/**'
    - '!node_modules/**/*.md'

functions:
  graphql:
    handler: src/handler.handler
    events:
      - httpApi:
          path: /graphql
          method: ANY
